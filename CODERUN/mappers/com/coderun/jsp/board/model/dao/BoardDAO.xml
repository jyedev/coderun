<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="BoardDAO">
	<resultMap type="com.coderun.jsp.board.model.dto.BoardDTO" id="generalBoardResultMap">
		<id property="no" column="BD_NO"/>
		<result property="title" column="BD_TITLE"/>
		<result property="content" column="BD_CONTENT"/>
		<result property="writerId" column="BD_WRITER_ID"/>
		<result property="date" column="BD_DATE"/>
		<result property="update" column="BD_UPDATE"/>
		<result property="delete" column="BD_DELETE"/>
		
		<association property="member" resultMap="memberResultMap"/>
		<collection property="commentList" resultMap="commentResultMap"/>
	</resultMap>
	
	<resultMap type="com.coderun.jsp.board.model.dto.CommentDTO" id="commentResultMap">
		<id property="no" column="CMT_NO"/>
		<result property="writerId" column="CMT_WRITER_ID"/>
		<result property="content" column="CMT_CONTENT"/>
		<result property="date" column="CMT_DATE"/>
		<result property="update" column="CMT_UPDATE"/>
		<result property="delete" column="CMT_DELETE"/>
		<result property="bdNo" column="CMT_BD_NO"/>
		
		<association property="member" resultMap="memberResultMap"/>
	</resultMap>
	
	<resultMap type="com.coderun.jsp.board.model.dto.ReportDTO" id="ReportResultMap">
		<id property="no" column="REP_NO"/>
		<result property="memberId" column="REP_MEMBER_ID"/>
		<result property="bdNo" column="REP_BD_NO"/>
		<result property="cmtNo" column="REP_CMT_NO"/>
		<result property="typeNo" column="REP_TYPE_NO"/>
		<result property="result" column="REP_RESULT"/>
		
		<association property="member" resultMap="memberResultMap"/>
		<association property="board" resultMap="boardResultMap"/>
		<association property="comment" resultMap="commentResultMap"/>
	</resultMap>
	
	<resultMap type="com.coderun.jsp.board.model.dto.ReportReasonDTO" id="ReportReasonResultMap">
		<id property="typeNo" column="REP_TYPE_NO"/>
		<result property="reason" column="REP_REASON"/>
		<association property="typeNo" resultMap="reportResultMap"/>
		
	</resultMap>
		
	<resultMap type="com.coderun.jsp.member.model.dto.MemberDTO" id="memberResultMap">
		<id property="id" column="MEMBER_ID"/>
		<result property="pwd" column="MEMBER_PWD"/>
		<result property="name" column="MEMBER_NAME"/>
		<result property="email" column="EMAIL"/>
		<result property="birthday" column="BIRTHDAY"/>
		<result property="gender" column="GENDER"/>
		<result property="type" column="MEMBER_TYPE"/>
		<result property="freepassYn" column="FREEPASS_YN"/>
		<result property="status" column="MEMBER_STATUS"/>
		
		<association property="image" resultMap="imageResultMap"/>
	</resultMap>
	
	<resultMap type="com.coderun.jsp.member.model.dto.ImageDTO" id="imageResultMap">
		<id property="no" column="IMG_NO"/>
		<result property="origin" column="IMG_ORIGIN"/>
		<result property="edit" column="IMG_EDIT"/>
		<result property="root" column="IMG_ROOT"/>
		<result property="memberId" column="IMG_MEMBER_ID"/>
	</resultMap>
	
	<select id="selectTotalCount" resultType="_int" parameterType="hashmap">
        SELECT COUNT(*)
          FROM TB_BOARD
    	<where>
			<if test="searchCondition == 'title'">
	           BD_TITLE LIKE '%' || #{ searchValue } || '%'
			</if>
			<if test="searchCondition == 'content'">
	           BD_CONTENT LIKE '%' || #{ searchValue } || '%'
			</if>
	       AND BD_DELETE = 'N'
    	</where>
	</select>
	<select id="selectBoardList" resultMap="generalBoardResultMap">
    SELECT /* com.greedy.jsp.board.model.dao.BoardDAO#selectBoardList() */
               A.RNUM
 	 		 , A.BD_NO
 	 		 , A.BD_TITLE 
 	 		 , A.BD_CONTENT
 	 		 , A.BD_WRITER_ID
 	 		 , A.BD_DATE
 	 		 , A.BD_UPDATE
 	 		 , A.BD_DELETE
          FROM (SELECT ROWNUM RNUM
                     , B.BD_NO
                     , B.BD_TITLE
                     , B.BD_CONTENT
                     , B.BD_WRITER_ID
                     , B.BD_DATE
                     , B.BD_UPDATE
                     , B.BD_DELETE
                  FROM (SELECT C.BD_NO
                  			 , C.BD_TITLE
                  			 , C.BD_CONTENT
                  			 , C.BD_WRITER_ID
                  			 , C.BD_DATE
                  			 , C.BD_UPDATE
                  			 , C.BD_DELETE
                          FROM TB_BOARD C
    					<where>
							<if test="searchCondition == 'title'">
	           				   C.BD_TITLE LIKE '%' || #{ searchValue } || '%' 	
							</if>
							<if test="searchCondition == 'content'">
	           				   C.BD_CONTENT LIKE '%' || #{ searchValue } || '%' 	
							</if>
	       				   AND C.BD_DELETE = 'N'
    					</where>
                         ORDER BY C.BD_NO DESC
                        ) B
                  <![CDATA[
                  WHERE ROWNUM <= #{ endRow }
                  ]]>
               ) A
		 JOIN TB_MEMBER D ON(A.BD_WRITER_ID = D.MEMBER_ID)
         WHERE A.RNUM >= #{ startRow }     
         ORDER BY A.RNUM 
	</select>
	<insert id="insertBoard">
        INSERT
          INTO TB_BOARD 
        (BD_NO, BD_TITLE, BD_CONTENT, BD_WRITER_ID)
        VALUES
        ( SEQ_BD_NO.NEXTVAL, #{ title }, #{ content }, #{ writerId })
	</insert>
	
	
	<select id="selectBoardView" resultMap="generalBoardResultMap">
        SELECT
               A.BD_NO
             , A.BD_TITLE
             , A.BD_CONTENT
             , A.BD_WRITER_ID
             , A.BD_DATE
             , A.BD_UPDATE
             , B.CMT_NO
             , B.CMT_WRITER_ID
             , B.CMT_CONTENT
             , B.CMT_DATE
             , B.CMT_UPDATE
             , B.CMT_DELETE
             , C.IMG_ORIGIN
             , C.IMG_EDIT
             , C.IMG_ROOT
          FROM TB_BOARD A
          LEFT JOIN TB_COMMENT B ON (A.BD_NO = B.CMT_BD_NO)
          LEFT JOIN TB_IMAGE C ON (B.CMT_WRITER_ID = C.IMG_MEMBER_ID)
         WHERE A.BD_DELETE = 'N'
           AND A.BD_NO = #{ no }
	</select>
	
	<update id="updateBoard">
	UPDATE 
	       TB_BOARD
	   SET BD_TITLE = #{ title }
	     , BD_CONTENT = #{ content }
	     , BD_UPDATE = SYSDATE
	 WHERE BD_NO = #{ no }
	</update>
	
	<update id="deleteBoard">
		UPDATE
		       TB_BOARD
		   SET BD_DELETE = 'Y'
		 WHERE BD_NO = #{ no }
	</update>
		
	<select id="selectTotalReportCount" resultType="_int" parameterType="hashmap">
        SELECT COUNT(*)
          FROM TB_REPORT
    	<where>
			<if test="searchCondition == 'memberId'">
	           REP_MEMBER_ID LIKE '%' || #{ searchValue } || '%'
			</if>
			<if test="searchCondition == 'typeNo'">
	           REP_TYPE_NO LIKE '%' || #{ searchValue } || '%'
			</if>
	       AND REP_RESULT = 'N'
    	</where>
	</select>
	
	<select id="selectReportList" resultMap="ReportResultMap">
	
		SELECT
			   A.RNUM
			 , A.REP_NO
			 , A.REP_MEMBER_ID
			 , A.REP_BD_NO
			 , A.REP_CMT_NO
			 , A.REP_TYPE_NO
			 , A.REP_RESULT
		  FROM (SELECT ROWNUM RNUM
		  			 , B.REP_NO
					 , B.REP_MEMBER_ID
					 , B.REP_BD_NO
					 , B.REP_CMT_NO
					 , B.REP_TYPE_NO
					 , B.REP_RESULT
		  		  FROM (SELECT C.REP_NO
							 , C.REP_MEMBER_ID
							 , C.REP_BD_NO
							 , C.REP_CMT_NO
							 , C.REP_TYPE_NO
							 , C.REP_RESULT
		  		  		  FROM TB_REPORT C
		<if test="searchCondition == 'memberId'">
           REP_MEMBER_ID LIKE '%' || #{ searchValue } || '%'
		</if>
		<if test="searchCondition == 'typeNo'">
           REP_TYPE_NO LIKE '%' || #{ searchValue } || '%'
		</if>
	 	)B
		<![CDATA[
		 WHERE ROWNUM <= #{ endRow }
		 ]]>
		 ) A
		 WHERE A.RNUM >= #{ startRow }
	</select>
	
	<insert id="insertReport">
       INSERT
         INTO TB_REPORT 
       (REP_NO, REP_MEMBER_ID, REP_BD_NO, REP_CMT_NO, REP_TYPE_NO)
       VALUES
       ( SEQ_REP_NO.NEXTVAL, #{ memberId }, #{bdNo}, #{ cmtNo }, #{typeNo})
	</insert>
	
</mapper>